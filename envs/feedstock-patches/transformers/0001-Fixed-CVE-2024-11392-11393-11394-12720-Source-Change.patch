From fcdba8b17240f8107b52aa6f798ff8779cee09d2 Mon Sep 17 00:00:00 2001
From: Vibhav Dhaimode <Vibhav.Dhaimode2@ibm.com>
Date: Wed, 23 Apr 2025 11:02:50 +0000
Subject: [PATCH] Fixed-CVE-2024-11392-11393-11394-12720-Source-Change

---
 ...1-Fix-for-CVE-2024-11392-11393-11394.patch | 90 +++++++++++++++++++
 .../0001-Fix-for-CVE-2024-12720.patch         | 25 ++++++
 transformers-4.37.2/meta.yaml                 | 68 ++++++++++++++
 ...1-Fix-for-CVE-2024-11392-11393-11394.patch | 90 +++++++++++++++++++
 .../0001-Fix-for-CVE-2024-12720.patch         | 25 ++++++
 {recipe => transformers-4.38.0}/meta.yaml     |  9 +-
 6 files changed, 304 insertions(+), 3 deletions(-)
 create mode 100644 transformers-4.37.2/0001-Fix-for-CVE-2024-11392-11393-11394.patch
 create mode 100644 transformers-4.37.2/0001-Fix-for-CVE-2024-12720.patch
 create mode 100644 transformers-4.37.2/meta.yaml
 create mode 100644 transformers-4.38.0/0001-Fix-for-CVE-2024-11392-11393-11394.patch
 create mode 100644 transformers-4.38.0/0001-Fix-for-CVE-2024-12720.patch
 rename {recipe => transformers-4.38.0}/meta.yaml (81%)

diff --git a/transformers-4.37.2/0001-Fix-for-CVE-2024-11392-11393-11394.patch b/transformers-4.37.2/0001-Fix-for-CVE-2024-11392-11393-11394.patch
new file mode 100644
index 0000000..fd5db3c
--- /dev/null
+++ b/transformers-4.37.2/0001-Fix-for-CVE-2024-11392-11393-11394.patch
@@ -0,0 +1,90 @@
+From 2f46db656fc7cca1a859c59641f0a5ea5487086e Mon Sep 17 00:00:00 2001
+From: Aman Surkar <Aman.Surkar@ibm.com>
+Date: Tue, 8 Apr 2025 08:25:02 +0000
+Subject: [PATCH] Fix for CVE-2024-11392/11393/11394
+
+---
+ setup.py         |  2 +-
+ utils/release.py | 19 +++++++++++++++++--
+ 2 files changed, 18 insertions(+), 3 deletions(-)
+
+diff --git a/setup.py b/setup.py
+index 91eabe25fb..35c30c29a1 100644
+--- a/setup.py
++++ b/setup.py
+@@ -20,7 +20,7 @@ To create the package for pypi.
+ 1. Create the release branch named: v<RELEASE>-release, for example v4.19-release. For a patch release checkout the
+    current release branch.
+
+-   If releasing on a special branch, copy the updated README.md on the main branch for your the commit you will make
++   If releasing on a special branch, copy the updated README.md on the main branch for the commit you will make
+    for the post-release and run `make fix-copies` on the main branch as well.
+
+ 2. Run `make pre-release` (or `make pre-patch` for a patch release) and commit these changes with the message:
+diff --git a/utils/release.py b/utils/release.py
+index 8ba0ead7c6..e75f002471 100644
+--- a/utils/release.py
++++ b/utils/release.py
+@@ -44,12 +44,14 @@ or use `make post-release`.
+ import argparse
+ import os
+ import re
++from pathlib import Path
+
+ import packaging.version
+
+
+ # All paths are defined with the intent that this script should be run from the root of the repo.
+ PATH_TO_EXAMPLES = "examples/"
++PATH_TO_MODELS = "src/transformers/models"
+ # This maps a type of file to the pattern to look for when searching where the version is defined, as well as the
+ # template to follow when replacing it with the new version.
+ REPLACE_PATTERNS = {
+@@ -115,6 +117,17 @@ def global_version_update(version: str, patch: bool = False):
+         # We don't update the version in the examples for patch releases.
+         update_version_in_examples(version)
+
++def remove_conversion_scripts():
++    """
++    Delete the scripts that convert models from older, unsupported formats. We don't want to include these
++    in release wheels because they often have to open insecure file types (pickle, Torch .bin models). This results in
++    vulnerability scanners flagging us and can cause compliance issues for users with strict security policies.
++    """
++    model_dir = Path(PATH_TO_MODELS)
++    for conversion_script in list(model_dir.glob("**/convert*.py")):
++        conversion_script.unlink()
++
++
+
+ def clean_main_ref_in_model_list():
+     """
+@@ -160,7 +173,7 @@ def pre_release_work(patch: bool = False):
+     """
+     Do all the necessary pre-release steps:
+     - figure out the next minor release version and ask confirmation
+-    - update the version eveywhere
++    - update the version everywhere
+     - clean-up the model list in the main README
+
+     Args:
+@@ -184,6 +197,8 @@ def pre_release_work(patch: bool = False):
+
+     print(f"Updating version to {version}.")
+     global_version_update(version, patch=patch)
++    print("Deleting conversion scripts.")
++    remove_conversion_scripts()
+     if not patch:
+         print("Cleaning main README, don't forget to run `make fix-copies`.")
+         clean_main_ref_in_model_list()
+@@ -193,7 +208,7 @@ def post_release_work():
+     """
+     Do all the necesarry post-release steps:
+     - figure out the next dev version and ask confirmation
+-    - update the version eveywhere
++    - update the version everywhere
+     - clean-up the model list in the main README
+     """
+     # First let's get the current version
+--
+2.40.1
+
diff --git a/transformers-4.37.2/0001-Fix-for-CVE-2024-12720.patch b/transformers-4.37.2/0001-Fix-for-CVE-2024-12720.patch
new file mode 100644
index 0000000..17f00ae
--- /dev/null
+++ b/transformers-4.37.2/0001-Fix-for-CVE-2024-12720.patch
@@ -0,0 +1,25 @@
+From 6e2d70f6bb26f1029c2c277f18eb6e7a1798ee89 Mon Sep 17 00:00:00 2001
+From: Aman Surkar <Aman.Surkar@ibm.com>
+Date: Tue, 8 Apr 2025 08:27:27 +0000
+Subject: [PATCH] Fix for CVE-2024-12720
+
+---
+ src/transformers/models/nougat/tokenization_nougat_fast.py | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/src/transformers/models/nougat/tokenization_nougat_fast.py b/src/transformers/models/nougat/tokenization_nougat_fast.py
+index d02aec7575..0e96509e39 100644
+--- a/src/transformers/models/nougat/tokenization_nougat_fast.py
++++ b/src/transformers/models/nougat/tokenization_nougat_fast.py
+@@ -522,7 +522,7 @@ class NougatTokenizerFast(PreTrainedTokenizerFast):
+         generation = generation.replace("\n* [leftmargin=*]\n", "\n")
+         # Remove lines with markdown headings starting with #, with numerals,
+         # and possibly roman numerals with trailing spaces and newlines
+-        generation = re.sub(r"^#+ (?:\.?(?:\d|[ixv])+)*\s*(?:$|\n\s*)", "", generation, flags=re.M)
++        generation = re.sub(r"^#+ (?:[\d+\.]+|[ixv\.]+)?\s*(?:$|\n\s*)", "", generation, flags=re.M)
+         # most likely hallucinated titles
+         lines = generation.split("\n")
+         if lines[-1].startswith("#") and lines[-1].lstrip("#").startswith(" ") and len(lines) > 1:
+--
+2.40.1
+
diff --git a/transformers-4.37.2/meta.yaml b/transformers-4.37.2/meta.yaml
new file mode 100644
index 0000000..8882678
--- /dev/null
+++ b/transformers-4.37.2/meta.yaml
@@ -0,0 +1,68 @@
+{% set name = "transformers" %}
+{% set version = "4.37.2" %}
+
+package:
+  name: {{ name|lower }}
+  version: {{ version }}
+
+source:
+  url: https://github.com/huggingface/transformers/archive/refs/tags/v4.37.2.tar.gz
+  sha256: 792c01be033403eafd699555e7948e17a8f8ee3d860f221ff79e760f36342767
+  patches:
+    - 0001-Fix-for-CVE-2024-11392-11393-11394.patch
+    - 0001-Fix-for-CVE-2024-12720.patch
+
+build:
+  noarch: python
+  number: 0
+  script: {{ PYTHON }} -m pip install . -vv
+
+requirements:
+  host:
+    - pip
+    - python >=3.8
+  run:
+    - python >=3.8
+    - datasets !=2.5.0  # Required for transformers-cli.
+    - filelock
+    - huggingface_hub >=0.19.3,<1.0
+    - numpy {{ numpy }}
+    - regex !=2019.12.17
+    - requests
+    - safetensors >=0.4.1
+    - packaging >=20.0
+    - pyyaml >=5.1
+    - tqdm >=4.27
+    - tokenizers >=0.15,<0.19
+
+test:
+  imports:
+    - transformers
+    - transformers.benchmark
+    - transformers.commands
+    - transformers.data
+    - transformers.kernels
+    - transformers.models
+    - transformers.pipelines
+    - transformers.tools
+    - transformers.utils
+
+  commands:
+    - transformers-cli --help
+
+about:
+  home: https://github.com/huggingface/transformers
+  license: Apache-2.0
+  license_family: APACHE
+  license_file: LICENSE
+  summary: State-of-the-art Natural Language Processing for TensorFlow 2.0 and PyTorch
+  doc_url: https://huggingface.co/transformers/
+
+extra:
+  recipe-maintainers:
+    - mxr-conda
+    - roccqqck
+    - oblute
+    - rluria14
+    - ndmaxar
+    - setu4993
diff --git a/transformers-4.38.0/0001-Fix-for-CVE-2024-11392-11393-11394.patch b/transformers-4.38.0/0001-Fix-for-CVE-2024-11392-11393-11394.patch
new file mode 100644
index 0000000..fd5db3c
--- /dev/null
+++ b/transformers-4.38.0/0001-Fix-for-CVE-2024-11392-11393-11394.patch
@@ -0,0 +1,90 @@
+From 2f46db656fc7cca1a859c59641f0a5ea5487086e Mon Sep 17 00:00:00 2001
+From: Aman Surkar <Aman.Surkar@ibm.com>
+Date: Tue, 8 Apr 2025 08:25:02 +0000
+Subject: [PATCH] Fix for CVE-2024-11392/11393/11394
+
+---
+ setup.py         |  2 +-
+ utils/release.py | 19 +++++++++++++++++--
+ 2 files changed, 18 insertions(+), 3 deletions(-)
+
+diff --git a/setup.py b/setup.py
+index 91eabe25fb..35c30c29a1 100644
+--- a/setup.py
++++ b/setup.py
+@@ -20,7 +20,7 @@ To create the package for pypi.
+ 1. Create the release branch named: v<RELEASE>-release, for example v4.19-release. For a patch release checkout the
+    current release branch.
+
+-   If releasing on a special branch, copy the updated README.md on the main branch for your the commit you will make
++   If releasing on a special branch, copy the updated README.md on the main branch for the commit you will make
+    for the post-release and run `make fix-copies` on the main branch as well.
+
+ 2. Run `make pre-release` (or `make pre-patch` for a patch release) and commit these changes with the message:
+diff --git a/utils/release.py b/utils/release.py
+index 8ba0ead7c6..e75f002471 100644
+--- a/utils/release.py
++++ b/utils/release.py
+@@ -44,12 +44,14 @@ or use `make post-release`.
+ import argparse
+ import os
+ import re
++from pathlib import Path
+
+ import packaging.version
+
+
+ # All paths are defined with the intent that this script should be run from the root of the repo.
+ PATH_TO_EXAMPLES = "examples/"
++PATH_TO_MODELS = "src/transformers/models"
+ # This maps a type of file to the pattern to look for when searching where the version is defined, as well as the
+ # template to follow when replacing it with the new version.
+ REPLACE_PATTERNS = {
+@@ -115,6 +117,17 @@ def global_version_update(version: str, patch: bool = False):
+         # We don't update the version in the examples for patch releases.
+         update_version_in_examples(version)
+
++def remove_conversion_scripts():
++    """
++    Delete the scripts that convert models from older, unsupported formats. We don't want to include these
++    in release wheels because they often have to open insecure file types (pickle, Torch .bin models). This results in
++    vulnerability scanners flagging us and can cause compliance issues for users with strict security policies.
++    """
++    model_dir = Path(PATH_TO_MODELS)
++    for conversion_script in list(model_dir.glob("**/convert*.py")):
++        conversion_script.unlink()
++
++
+
+ def clean_main_ref_in_model_list():
+     """
+@@ -160,7 +173,7 @@ def pre_release_work(patch: bool = False):
+     """
+     Do all the necessary pre-release steps:
+     - figure out the next minor release version and ask confirmation
+-    - update the version eveywhere
++    - update the version everywhere
+     - clean-up the model list in the main README
+
+     Args:
+@@ -184,6 +197,8 @@ def pre_release_work(patch: bool = False):
+
+     print(f"Updating version to {version}.")
+     global_version_update(version, patch=patch)
++    print("Deleting conversion scripts.")
++    remove_conversion_scripts()
+     if not patch:
+         print("Cleaning main README, don't forget to run `make fix-copies`.")
+         clean_main_ref_in_model_list()
+@@ -193,7 +208,7 @@ def post_release_work():
+     """
+     Do all the necesarry post-release steps:
+     - figure out the next dev version and ask confirmation
+-    - update the version eveywhere
++    - update the version everywhere
+     - clean-up the model list in the main README
+     """
+     # First let's get the current version
+--
+2.40.1
+
diff --git a/transformers-4.38.0/0001-Fix-for-CVE-2024-12720.patch b/transformers-4.38.0/0001-Fix-for-CVE-2024-12720.patch
new file mode 100644
index 0000000..17f00ae
--- /dev/null
+++ b/transformers-4.38.0/0001-Fix-for-CVE-2024-12720.patch
@@ -0,0 +1,25 @@
+From 6e2d70f6bb26f1029c2c277f18eb6e7a1798ee89 Mon Sep 17 00:00:00 2001
+From: Aman Surkar <Aman.Surkar@ibm.com>
+Date: Tue, 8 Apr 2025 08:27:27 +0000
+Subject: [PATCH] Fix for CVE-2024-12720
+
+---
+ src/transformers/models/nougat/tokenization_nougat_fast.py | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/src/transformers/models/nougat/tokenization_nougat_fast.py b/src/transformers/models/nougat/tokenization_nougat_fast.py
+index d02aec7575..0e96509e39 100644
+--- a/src/transformers/models/nougat/tokenization_nougat_fast.py
++++ b/src/transformers/models/nougat/tokenization_nougat_fast.py
+@@ -522,7 +522,7 @@ class NougatTokenizerFast(PreTrainedTokenizerFast):
+         generation = generation.replace("\n* [leftmargin=*]\n", "\n")
+         # Remove lines with markdown headings starting with #, with numerals,
+         # and possibly roman numerals with trailing spaces and newlines
+-        generation = re.sub(r"^#+ (?:\.?(?:\d|[ixv])+)*\s*(?:$|\n\s*)", "", generation, flags=re.M)
++        generation = re.sub(r"^#+ (?:[\d+\.]+|[ixv\.]+)?\s*(?:$|\n\s*)", "", generation, flags=re.M)
+         # most likely hallucinated titles
+         lines = generation.split("\n")
+         if lines[-1].startswith("#") and lines[-1].lstrip("#").startswith(" ") and len(lines) > 1:
+--
+2.40.1
+
diff --git a/recipe/meta.yaml b/transformers-4.38.0/meta.yaml
similarity index 81%
rename from recipe/meta.yaml
rename to transformers-4.38.0/meta.yaml
index 80688b6..5896432 100644
--- a/recipe/meta.yaml
+++ b/transformers-4.38.0/meta.yaml
@@ -6,8 +6,11 @@ package:
   version: {{ version }}

 source:
-  url: https://pypi.io/packages/source/{{ name[0] }}/{{ name }}/{{ name }}-{{ version }}.tar.gz
-  sha256: aa98177980467cb0c73f34b19d70d0577ec021c7c00706fbaca46ac358fd083c
+  url: https://github.com/huggingface/transformers/archive/refs/tags/v4.38.0.tar.gz
+  sha256: ee13db4eb3262bd0d87c348680c211fd68a3a85b3863c56de1920e705a767a4d
+  patches:
+    - 0001-Fix-for-CVE-2024-11392-11393-11394.patch
+    - 0001-Fix-for-CVE-2024-12720.patch

 build:
   noarch: python
@@ -23,7 +26,7 @@ requirements:
     - datasets !=2.5.0  # Required for transformers-cli.
     - filelock
     - huggingface_hub >=0.19.3,<1.0
-    - numpy >=1.17
+    - numpy {{ numpy }}
     - regex !=2019.12.17
     - requests
     - safetensors >=0.4.1
--
2.40.1

